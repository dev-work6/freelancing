(()=>{var e={};e.id=4131,e.ids=[4131],e.modules={56037:e=>{"use strict";e.exports=require("mongoose")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79646:e=>{"use strict";e.exports=require("child_process")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},28354:e=>{"use strict";e.exports=require("util")},11292:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>g,routeModule:()=>y,serverHooks:()=>f,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>S});var s={};r.r(s),r.d(s,{GET:()=>m,POST:()=>l});var n=r(42706),a=r(28203),i=r(45994),o=r(43694),c=r(25972),u=r(66993),d=r(39187);let p=new u.A(process.env.STRIPE_SECRET_KEY);async function l(e){let t;try{let{serviceId:r,userId:s,amount:n,customerName:a,customerAddress:i}=await e.json();if(!a||!i)return d.NextResponse.json({error:"Customer name and address are required for export transactions"},{status:400});await (0,o.A)();let u=await p.checkout.sessions.create({payment_method_types:["card"],customer_email:a,line_items:[{price_data:{currency:"inr",product_data:{name:"Service Payment",metadata:{customer_name:a,customer_address:i}},unit_amount:100*n},quantity:1}],mode:"payment",success_url:"http://localhost:3000/payment/success?session_id={CHECKOUT_SESSION_ID}",cancel_url:"http://localhost:3000/payment/cancel",payment_intent_data:{shipping:{name:a,address:{line1:i,country:"IN"}}}});return t=await c.A.create({userId:s,serviceId:r,amount:n,stripeSessionId:u.id,paymentStatus:"pending",customerName:a,customerAddress:i,currency:"inr",paymentMethod:"card",shipping:{name:a,address:{line1:i,country:"IN"}}}),d.NextResponse.json({url:u.url},{status:200})}catch(e){if(e instanceof Error&&"type"in e&&"code"in e&&"decline_code"in e&&"StripeCardError"===e.type){let r="Payment failed",s=e.code;switch(e.code){case"card_declined":switch(e.decline_code){case"insufficient_funds":r="Insufficient funds in the card";break;case"lost_card":r="This card has been reported as lost";break;case"stolen_card":r="This card has been reported as stolen";break;case"card_velocity_exceeded":r="Card velocity limit exceeded";break;default:r="Card was declined"}break;case"expired_card":r="The card has expired";break;case"incorrect_cvc":r="Incorrect CVC code";break;case"processing_error":r="An error occurred while processing the card";break;case"incorrect_number":r="Invalid card number"}return t&&await c.A.findOneAndUpdate({stripeSessionId:t.stripeSessionId},{paymentStatus:"failed",errorCode:s,errorMessage:r}),d.NextResponse.json({error:r},{status:400})}return d.NextResponse.json({error:"An unexpected error occurred"},{status:500})}}async function m(e){try{let{searchParams:t}=new URL(e.url),r=t.get("session_id");if(!r)return d.NextResponse.json({error:"Session ID required"},{status:400});await (0,o.A)();let s=await c.A.findOne({stripeSessionId:r});if(!s)return d.NextResponse.json({error:"Payment not found"},{status:404});let n=await p.checkout.sessions.retrieve(r);if("paid"===n.payment_status&&"success"!==s.paymentStatus)return s.paymentStatus="success",await s.save(),d.NextResponse.json({status:"Payment completed"},{status:200});return d.NextResponse.json({status:s.paymentStatus||"pending"},{status:200})}catch(e){return e instanceof Error?console.error("Payment status check error:",e.message):console.error("Payment status check error:",String(e)),d.NextResponse.json({error:"An error occurred while checking payment status"},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/payments/route",pathname:"/api/payments",filename:"route",bundlePath:"app/api/payments/route"},resolvedPagePath:"C:\\Users\\Administrator\\Desktop\\freelance_work_showcase\\app\\api\\payments\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:h,workUnitAsyncStorage:S,serverHooks:f}=y;function g(){return(0,i.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:S})}},96487:()=>{},78335:()=>{},43694:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var s=r(56037),n=r.n(s);if(!process.env.MONGODB_URI)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let a=process.env.MONGODB_URI,i=async function(){try{let e=await n().connect(a);return console.log("MongoDB connected successfully"),e}catch(e){throw console.error("Error connecting to MongoDB:",e),e}}},25972:(e,t,r)=>{"use strict";r.d(t,{A:()=>o,e:()=>c});var s=r(56037),n=r.n(s);let a=new(n()).Schema({userId:{type:n().Schema.Types.ObjectId,ref:"User",required:!0},serviceId:{type:n().Schema.Types.ObjectId,ref:"Service",required:!0},amount:{type:Number,required:!0},paymentStatus:{type:String,enum:["pending","completed","failed"],default:"pending"},stripeSessionId:{type:String,required:!0,unique:!0},customerName:{type:String,required:!0},customerAddress:{type:String,required:!0},currency:{type:String,default:"inr"},paymentMethod:{type:String,default:"card"},metadata:{type:Map,of:String,default:{}},errorCode:{type:String},errorMessage:{type:String},shipping:{name:String,address:{line1:String,country:{type:String,default:"IN"}}}},{timestamps:!0});a.statics.updatePaymentStatus=async function(e,t){return this.findOneAndUpdate({stripeSessionId:e},{paymentStatus:t},{new:!0})};let i=n().models.Payment||n().model("Payment",a),o=i,c=async(e,t)=>await i.updatePaymentStatus(e,t)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1989,5452,6993],()=>r(11292));module.exports=s})();